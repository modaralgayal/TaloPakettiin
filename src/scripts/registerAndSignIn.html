<script type="module">
  document.addEventListener("DOMContentLoaded", async function () {
    console.log("Fetching User for dynamic header...");

    try {
      // Make the API call to get the user data
      const response = await fetch(
        "https://serverapi.talopakettiin.fi/api/user/data",
        {
          method: "GET",
          credentials: "include", // Include cookies for authentication
        }
      );

      if (response.ok) {
        const contentType = response.headers.get("Content-Type");
        if (contentType && contentType.includes("application/json")) {
          const userData = await response.json();
          console.log("User data fetched:", userData);

          // Get the dynamic header container element
          const headerElement = document.getElementById("dynamicHeader");

          // Check if the user is logged in by checking the presence of `username`
          if (userData.username) {
            // User is logged in, request logged-in header shortcode
            const headerHTML = await fetchHeaderHTML(
              '[hfe_template id="1081"]'
            );
            headerElement.innerHTML = headerHTML;
          } else {
            // User is a guest, request guest header shortcode
            const headerHTML = await fetchHeaderHTML(
              '[hfe_template id="1076"]'
            );
            headerElement.innerHTML = headerHTML;
          }
        } else {
          console.error("Unexpected response type:", contentType);
        }
      } else {
        console.error("Failed to fetch user data:", response.statusText);
      }
    } catch (error) {
      console.error("Error fetching user data:", error.message);
    }
  });

  // Helper function to fetch the header template via AJAX
  async function fetchHeaderHTML(shortcode) {
    try {
      const response = await fetch(
        `https://talopakettiin.fi/wp-admin/admin-ajax.php?action=render_shortcode&shortcode=${encodeURIComponent(
          shortcode
        )}`
      );
      if (response.ok) {
        return await response.text();
      } else {
        console.error("Failed to fetch header template.");
        return "<p>Error loading header</p>";
      }
    } catch (error) {
      console.error("Error fetching header template:", error);
      return "<p>Error loading header</p>";
    }
  }
</script>
